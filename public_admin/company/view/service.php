<?php/* Add this on all pages on top. */set_include_path($_SERVER['DOCUMENT_ROOT'].'/'.PATH_SEPARATOR.$_SERVER['DOCUMENT_ROOT'].'/library/classes/');/** Standard includes */require_once 'config/database.php';require_once 'config/smarty.php';/** Check for login */require_once 'includes/auth.php';/* objects. */require_once 'class/company.php';require_once 'class/companyservice.php';$companyObject 			= new class_company();$companyserviceObject 	= new class_companyservice();if (isset($_GET['code']) && trim($_GET['code']) != '') {		$code = trim($_GET['code']);		$companyData = $companyObject->getByCode($code);		if(!$companyData) {		header('Location: /company/view/');		exit;	}		$companyserviceData = $companyserviceObject->getByCompany($companyData['company_code'], 'SERVICE');	if($companyserviceData) $smarty->assign('companyserviceData', $companyserviceData);		$smarty->assign('companyData', $companyData);	} else {	header('Location: /company/view/');	exit;}/* Check posted data. */if(isset($_GET['delete_code'])) {		$errorArray				= array();	$errorArray['error']	= '';	$errorArray['result']	= 0;		$formValid				= true;	$success					= NULL;	$itemcode					= trim($_GET['delete_code']);			if($errorArray['error']  == '' && $errorArray['result']  == 0 ) {			$data	= array();		$data['companyservice_deleted'] = 1;				$where		= array();		$where[]	= $companyserviceObject->getAdapter()->quoteInto('companyservice_code = ?', $itemcode);		$where[]	= $companyserviceObject->getAdapter()->quoteInto('company_code = ?', $companyData['company_code']);				$success	= $companyserviceObject->update($data, $where);					if(is_numeric($success) && $success > 0) {					$errorArray['error']	= '';			$errorArray['result']	= 1;					} else {			$errorArray['error']	= 'Could not delete, please try again.';			$errorArray['result']	= 0;						}	}		echo json_encode($errorArray);	exit;}/* Check posted data. */if(isset($_GET['update_code'])) {		$errorArray				= array();	$errorArray['error']	= '';	$errorArray['result']	= 0;	$data 						= array();	$formValid				= true;	$success					= NULL;	$itemcode					= trim($_GET['update_code']);		if(isset($_GET['companyservice_name']) && trim($_GET['companyservice_name']) == '') {		$errorArray['error'] = 'description required.';		}	if($errorArray['error']  == '') {		if(isset($_GET['companyservice_primary']) && trim($_GET['companyservice_primary']) == $itemcode) {						$companyserviceObject->updatePrimaryByCompany(trim($_GET['companyservice_primary']), $companyData['company_code'], 'SERVICE');					}				$data 	= array();				$data['companyservice_name'] 			= trim($_GET['companyservice_name']);				$where		= array();		$where[]	= $companyserviceObject->getAdapter()->quoteInto('companyservice_code = ?', $itemcode);		$where[]	= $companyserviceObject->getAdapter()->quoteInto('company_code = ?', $companyData['company_code']);		$success	= $companyserviceObject->update($data, $where);			if(is_numeric($success)) {					$errorArray['error']	= '';			$errorArray['result']	= 1;					} else {			$errorArray['error']	= 'Could not update, please try again.';			$errorArray['result']	= 0;						}	}		echo json_encode($errorArray);	exit;}/* Check posted data. */if(count($_POST) > 0) {	$errorArray	= array();	$data 			= array();	$formValid	= true;	$success		= NULL;		if(isset($_POST['companyservice_name']) && trim($_POST['companyservice_name']) == '') {		$errorArray['companyservice_name'] = 'required';		$formValid = false;			} else {			$count = $companyserviceObject->_rule_count($companyData['company_code'], 'SERVICE');				if($count == 0) {			$errorArray['category_code'] = 'You have exceeded the number of services, using: '.$companyData['_product_reference'];			$formValid = false;		}	}	if(count($errorArray) == 0 && $formValid == true) {				$data = array();		$data['companyservice_name']	= trim($_POST['companyservice_name']);		$data['companyservice_type']		= 'SERVICE';		$data['company_code']				= $companyData['company_code'];				/* Check for other images. */		$primary = $companyserviceObject->getPrimaryByCompany($companyData['company_code'], 'SERVICE');						if($primary) {			$data['companyservice_primary']	= 0;		} else {			$data['companyservice_primary']	= 1;		}						$success	= $companyserviceObject->insert($data);				if($success) {			header('Location: /company/view/service.php?code='.$companyData['company_code']);			exit;				}	}		/* if we are here there are errors. */	$smarty->assign('errorArray', $errorArray);}$smarty->display('company/view/service.tpl');?>