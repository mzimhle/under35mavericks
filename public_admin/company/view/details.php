<?php/* Add this on all pages on top. */set_include_path($_SERVER['DOCUMENT_ROOT'].'/'.PATH_SEPARATOR.$_SERVER['DOCUMENT_ROOT'].'/library/classes/');/*** Standard includes */require_once 'config/database.php';require_once 'config/smarty.php';/*** Check for login */require_once 'includes/auth.php';/* objects. */require_once 'class/company.php';require_once 'class/File.php';$companyObject 	= new class_company();$fileObject				= new File(array('gif', 'png', 'jpg', 'jpeg'));if (isset($_GET['code']) && trim($_GET['code']) != '') {		$code = trim($_GET['code']);		$companyData = $companyObject->getByCode($code);	if(!$companyData) {		header('Location: /company/view/');		exit;	}		$smarty->assign('companyData', $companyData);}/* Check posted data. */if(count($_POST) > 0) {	$errorArray		= array();	$data 				= array();	$formValid		= true;	$success			= NULL;	if(isset($_POST['participant_code']) && trim($_POST['participant_code']) == '') {		$errorArray['participant_code'] = 'Registered business owner required';		$formValid = false;			}		if(isset($_POST['company_description']) && trim($_POST['company_description']) == '' ) {		$errorArray['company_description'] = 'Description is required';		$formValid = false;			} else if(strlen(trim($_POST['company_description'])) < 0 || strlen(trim($_POST['company_description'])) > 200) {		$errorArray['company_description'] = 'characters need to be less than 200 characters';		$formValid = false;				}		if(isset($_POST['company_name']) && trim($_POST['company_name']) == '') {		$errorArray['company_name'] = 'Company name required';		$formValid = false;			}		if(isset($_POST['company_email']) && trim($_POST['company_email']) != '') {		if($companyObject->validateEmail(trim($_POST['company_email'])) == '') {			$errorArray['company_email'] = 'Needs to be a valid email address';			$formValid = false;			}	} else {		$errorArray['company_email'] = 'Company email address required';		$formValid = false;				}		if(isset($_POST['areapost_code']) && trim($_POST['areapost_code']) == '') {		$errorArray['areapost_code'] = 'Area location is required';		$formValid = false;			}		if(isset($_POST['company_address']) && trim($_POST['company_address']) == '') {		$errorArray['company_address'] = 'Physical address required';		$formValid = false;			}		if(isset($_POST['company_website']) && trim($_POST['company_website']) != '')  {		if($companyObject->validateDomain(trim($_POST['company_website'])) == '') {			$errorArray['company_website'] = 'Needs to be a valid domain';			$formValid = false;				}	}		if(isset($_POST['company_telephone']) && trim($_POST['company_telephone']) != '') {		if($companyObject->validateCell(trim($_POST['company_telephone'])) == '') {			$errorArray['company_telephone'] = 'Needs to be a valid telephone';			$formValid = false;			}	}		if(isset($_POST['company_fax']) && trim($_POST['company_fax']) != '') {		if($companyObject->validateCell(trim($_POST['company_fax'])) == '') {			$errorArray['company_fax'] = 'Needs to be a valid fax number';			$formValid = false;			}	}		if(isset($_POST['company_cellphone']) && trim($_POST['company_cellphone']) != '') {		if($companyObject->validateCell(trim($_POST['company_cellphone'])) == '') {			$errorArray['company_cellphone'] = 'Needs to be a valid cell number';			$formValid = false;			}	}		if(isset($_FILES['imagelogo'])) {		/* Check validity of the CV. */		if((int)$_FILES['imagelogo']['size'] != 0 && trim($_FILES['imagelogo']['name']) != '') {			/* Check if its the right file. */			$ext = $fileObject->file_extention($_FILES['imagelogo']['name']); 			if($ext != '') {								$checkExt = $fileObject->getValidateExtention('imagelogo', $ext);								if(!$checkExt) {					$errorArray['imagelogo'] = 'Invalid file type something funny with the file format, try another one';					$formValid = false;										} else {					/* Check width and height */					$imagelogo = getimagesize($_FILES['imagelogo']['tmp_name']);										if($imagelogo[0] < 150 || $imagelogo < 150) {						$errorArray['imagelogo'] = 'Image needs to have a width more than 150 pixels as well as a height that is more than 150 pixels';						$formValid = false;												}				}			} else {				$errorArray['imagelogo'] = 'Invalid file type';				$formValid = false;												}		} else {						switch((int)$_FILES['imagelogo']['error']) {				case 1 : $errorArray['imagelogo'] = 'The uploaded file exceeds the maximum upload file size, should be less than 1M'; $formValid = false; break;				case 2 : $errorArray['imagelogo'] = 'File size exceeds the maximum file size'; $formValid = false; break;				case 3 : $errorArray['imagelogo'] = 'File was only partically uploaded, please try again'; $formValid = false; break;				//case 4 : $errorArray['imagelogo'] = 'No file was uploaded'; $formValid = false; break;				case 6 : $errorArray['imagelogo'] = 'Missing a temporary folder'; $formValid = false; break;				case 7 : $errorArray['imagelogo'] = 'Faild to write file to disk'; $formValid = false; break;			}		}	}		if(isset($_POST['company_longitude']) && trim($_POST['company_longitude']) == '') {		$errorArray['company_longitude'] = 'Location required';		$formValid = false;			}	if(isset($_POST['company_latitude']) && trim($_POST['company_latitude']) == '') {		$errorArray['company_latitude'] = 'Location required';		$formValid = false;			}	if(count($errorArray) == 0 && $formValid == true) {						$data 	= array();								$data['areapost_code']				= trim($_POST['areapost_code']);		$data['participant_code']			= trim($_POST['participant_code']);		$data['company_name']				= trim($_POST['company_name']);		$data['company_description']		= trim($_POST['company_description']);		$data['company_email']				= trim($_POST['company_email']);		$data['company_address']			= trim($_POST['company_address']);		$data['company_postal']				= trim($_POST['company_postal']);				$data['company_telephone']		= trim($_POST['company_telephone']);			$data['company_fax']					= trim($_POST['company_fax']);			$data['company_cellphone']		= trim($_POST['company_cellphone']);			$data['company_website']			= $companyObject->validateDomain(trim($_POST['company_website']));					$data['company_latitude']			= trim($_POST['company_latitude']);			$data['company_longitude']		= trim($_POST['company_longitude']);			$data['company_tax']					= trim($_POST['company_tax']);			$data['company_registration']		= trim($_POST['company_registration']);							if(isset($companyData)) {					/*Update. */						$where		= $companyObject->getAdapter()->quoteInto('company_code = ?', $companyData['company_code']);			$success	= $companyObject->update($data, $where);				$success	= $companyData['company_code'];		} else {						$success = $companyObject->insert($data);						}				/* UPLOAD LOGO. */		if(isset($_FILES['imagelogo'])) {			if((int)$_FILES['imagelogo']['size'] != 0 && trim($_FILES['imagelogo']['name']) != '') {								$image = array();				$image['company_logo_name']	= $fileObject->getRandomFileName();				$image['company_logo_path']		= '';				$image['company_logo_ext']		= '';								$ext 			= strtolower($fileObject->file_extention($_FILES['imagelogo']['name']));									$filename	= $image['company_logo_name'].'.'.$ext;							$directory	= $_SERVER['DOCUMENT_ROOT'].'/media/company/logo/'.$success.'/';				$file			= $directory.'/'.$filename;									if(!is_dir($directory)) mkdir($directory, 0777, true);				foreach($fileObject->logo as $item) {										$newfilename = str_replace($filename, $item['code'].$filename, $file);										$uploadObject	= PhpThumbFactory::create($_FILES['imagelogo']['tmp_name']);					$uploadObject->resize($item['width'], $item['height']);					$uploadObject->save($newfilename);								}				$image['company_logo_path']	= '/media/company/logo/'.$success.'/';				$image['company_logo_ext']	= '.'.$ext;				$image['company_code']		= $success;				$where = $companyObject->getAdapter()->quoteInto('company_code = ?', $success);				$companyObject->update($image, $where);									}		}				if(count($errorArray) == 0) {			header('Location: /company/view/category.php?code='.$success);				exit;				}				}		/* if we are here there are errors. */	$smarty->assign('errorArray', $errorArray);	}$smarty->display('company/view/details.tpl');?>